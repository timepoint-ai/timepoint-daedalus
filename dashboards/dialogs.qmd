---
title: "Dialog Navigator"
format:
  html:
    page-layout: full
    code-tools: false
---

::: {.callout-note}
## Navigation
[‚Üê Dashboard](index.html) | [Browse Runs](runs.html)
:::

```{ojs}
//| echo: false

// API configuration
API_BASE = "http://localhost:8000"

// Get run_id from URL parameter
urlParams = new URLSearchParams(window.location.search)
runId = urlParams.get('run_id')

// Fetch dialogs data
dialogData = runId ? (async () => {
  try {
    const response = await fetch(`${API_BASE}/api/dialogs/${runId}`);
    if (!response.ok) throw new Error('Dialogs not found');
    return await response.json();
  } catch (error) {
    console.error('Error fetching dialogs:', error);
    return null;
  }
})() : null

dialogResponse = await dialogData
dialogs = dialogResponse?.dialogs || []
```

::: {.panel}
${runId ? '' : html`<div class="alert alert-warning">‚ö†Ô∏è No run ID specified. Navigate from a run to view its dialogs.</div>`}
:::

## Dialogs: ${runId || 'Not selected'}

**Total Dialogs:** ${dialogs.length}

```{ojs}
//| echo: false

// Extract unique characters
characters = [...new Set(dialogs.map(d => d.speaker).filter(Boolean))]

// Extract unique timepoints
timepoints = [...new Set(dialogs.map(d => d.timepoint_id).filter(Boolean))]

// Extract unique locations
locations = [...new Set(dialogs.map(d => d.location).filter(Boolean))]
```

::: {.grid}

::: {.g-col-12 .g-col-md-3}
### Filters

```{ojs}
//| echo: false

viewof characterFilter = characters.length > 0 ? Inputs.select(
  ['All Characters'].concat(characters.sort()),
  {label: "Character", value: "All Characters"}
) : html`<p class="text-muted">No characters available</p>`

viewof timepointFilter = timepoints.length > 0 ? Inputs.select(
  ['All Timepoints'].concat(timepoints.sort()),
  {label: "Timepoint", value: "All Timepoints"}
) : html`<p class="text-muted">No timepoints available</p>`

viewof locationFilter = locations.length > 0 ? Inputs.select(
  ['All Locations'].concat(locations.sort()),
  {label: "Location", value: "All Locations"}
) : html`<p class="text-muted">No locations available</p>`

viewof searchQuery = Inputs.text({
  label: "Search Text",
  placeholder: "Search dialog content..."
})

viewof sortOrder = Inputs.select(
  ["Chronological", "By Character", "By Location"],
  {label: "Sort By", value: "Chronological"}
)
```

**Statistics:**

```{ojs}
//| echo: false

html`
<div style="background: #f8f9fa; padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem;">
  <div style="margin-bottom: 0.5rem;">
    <strong>Characters:</strong> ${characters.length}
  </div>
  <div style="margin-bottom: 0.5rem;">
    <strong>Timepoints:</strong> ${timepoints.length}
  </div>
  <div>
    <strong>Locations:</strong> ${locations.length}
  </div>
</div>
`
```

:::

::: {.g-col-12 .g-col-md-9}

```{ojs}
//| echo: false

// Filter dialogs
filteredDialogs = {
  let filtered = dialogs;

  // Filter by character
  if (characterFilter !== 'All Characters') {
    filtered = filtered.filter(d => d.speaker === characterFilter);
  }

  // Filter by timepoint
  if (timepointFilter !== 'All Timepoints') {
    filtered = filtered.filter(d => d.timepoint_id === timepointFilter);
  }

  // Filter by location
  if (locationFilter !== 'All Locations') {
    filtered = filtered.filter(d => d.location === locationFilter);
  }

  // Filter by search query
  if (searchQuery) {
    const searchLower = searchQuery.toLowerCase();
    filtered = filtered.filter(d =>
      (d.dialog && d.dialog.toLowerCase().includes(searchLower)) ||
      (d.speaker && d.speaker.toLowerCase().includes(searchLower)) ||
      (d.context && d.context.toLowerCase().includes(searchLower))
    );
  }

  // Sort
  if (sortOrder === "By Character") {
    filtered = filtered.sort((a, b) => (a.speaker || '').localeCompare(b.speaker || ''));
  } else if (sortOrder === "By Location") {
    filtered = filtered.sort((a, b) => (a.location || '').localeCompare(b.location || ''));
  } else {
    // Chronological (by index or timepoint)
    filtered = filtered.sort((a, b) => {
      const aTime = a.timepoint_id || '';
      const bTime = b.timepoint_id || '';
      return aTime.localeCompare(bTime);
    });
  }

  return filtered;
}

dialogsView = {
  if (dialogs.length === 0) {
    return html`<div class="alert alert-info">No dialogs available for this run.</div>`;
  }

  return html`
    <div style="margin-bottom: 1rem;">
      <strong>Showing ${filteredDialogs.length} of ${dialogs.length} dialogs</strong>
    </div>

    <div class="dialogs-container">
      ${filteredDialogs.map((dialog, idx) => html`
        <div class="dialog-card" id="dialog-${idx}">
          <div class="dialog-header">
            <div class="dialog-meta">
              <span class="character-badge">${dialog.speaker || 'Unknown'}</span>
              ${dialog.timepoint_id ? html`<span class="timepoint-badge">${dialog.timepoint_id}</span>` : ''}
              ${dialog.location ? html`<span class="location-badge">üìç ${dialog.location}</span>` : ''}
            </div>
            ${dialog.timestamp ? html`<div class="dialog-timestamp"><small>${dialog.timestamp}</small></div>` : ''}
          </div>

          <div class="dialog-content">
            ${dialog.dialog || 'No dialog text'}
          </div>

          ${dialog.context ? html`
            <div class="dialog-context">
              <strong>Context:</strong> ${dialog.context}
            </div>
          ` : ''}

          ${dialog.emotional_state ? html`
            <div class="dialog-emotion">
              <strong>Emotion:</strong> ${dialog.emotional_state}
            </div>
          ` : ''}
        </div>
      `).join('')}
    </div>

    <style>
      .dialogs-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .dialog-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: box-shadow 0.2s;
      }

      .dialog-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }

      .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
      }

      .dialog-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .character-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .timepoint-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.875rem;
        border: 1px solid #1976d2;
      }

      .location-badge {
        background: #f3e5f5;
        color: #7b1fa2;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        border: 1px solid #7b1fa2;
      }

      .dialog-timestamp {
        color: #6c757d;
      }

      .dialog-content {
        font-size: 1rem;
        line-height: 1.6;
        color: #212529;
        margin-bottom: 0.5rem;
      }

      .dialog-context {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        color: #495057;
        margin-top: 0.5rem;
      }

      .dialog-emotion {
        background: #fff3cd;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        color: #856404;
        margin-top: 0.5rem;
      }
    </style>
  `;
}
```

:::

:::

## Timeline View

```{ojs}
//| echo: false

timelineView = {
  if (dialogs.length === 0) {
    return html`<div class="alert alert-info">No data for timeline view.</div>`;
  }

  // Group dialogs by timepoint
  const byTimepoint = {};
  filteredDialogs.forEach(d => {
    const tp = d.timepoint_id || 'Unknown';
    if (!byTimepoint[tp]) byTimepoint[tp] = [];
    byTimepoint[tp].push(d);
  });

  const timepoints = Object.keys(byTimepoint).sort();

  if (timepoints.length === 0) {
    return html`<div class="alert alert-info">No timepoint data available.</div>`;
  }

  return html`
    <div class="timeline-container">
      ${timepoints.map(tp => html`
        <div class="timeline-section">
          <h4 class="timeline-heading">${tp}</h4>
          <div class="timeline-count">${byTimepoint[tp].length} dialog(s)</div>
          <div class="timeline-speakers">
            ${[...new Set(byTimepoint[tp].map(d => d.speaker))].join(', ')}
          </div>
        </div>
      `).join('')}
    </div>

    <style>
      .timeline-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
      }

      .timeline-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        flex: 1;
        min-width: 200px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .timeline-heading {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .timeline-count {
        font-size: 0.875rem;
        opacity: 0.9;
        margin-bottom: 0.25rem;
      }

      .timeline-speakers {
        font-size: 0.875rem;
        opacity: 0.85;
        font-style: italic;
      }
    </style>
  `;
}
```

## Export

```{ojs}
//| echo: false

exportButton = dialogs.length > 0 ? html`
  <button
    onclick="${() => {
      const csv = [
        ['Speaker', 'Timepoint', 'Location', 'Dialog', 'Context', 'Emotion'].join(','),
        ...filteredDialogs.map(d => [
          d.speaker || '',
          d.timepoint_id || '',
          d.location || '',
          `"${(d.dialog || '').replace(/"/g, '""')}"`,
          `"${(d.context || '').replace(/"/g, '""')}"`,
          d.emotional_state || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dialogs_${runId}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }}"
    style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    "
  >
    ‚¨á Export to CSV (${filteredDialogs.length} dialogs)
  </button>
` : ''
```
