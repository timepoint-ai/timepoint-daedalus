---
title: "Meta-Analytics"
format:
  html:
    page-layout: full
    code-tools: false
    include-in-header:
      - text: |
          <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
---

::: {.callout-note}
## Navigation
[‚Üê Browse Runs](runs.html) | [Dashboard](index.html)
:::

```{ojs}
//| echo: false

// API configuration
API_BASE = "http://localhost:8000"

// Fetch meta-analytics
analytics = {
  const response = await fetch(`${API_BASE}/api/meta-analytics`);
  return await response.json();
}
```

## Overview Metrics

::: {.grid}

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card">
  <div class="metric-value">${analytics.total_runs || 0}</div>
  <div class="metric-label">Total Runs</div>
</div>

<style>
  .metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .metric-label {
    font-size: 0.875rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
  <div class="metric-value">$${(analytics.total_cost || 0).toFixed(2)}</div>
  <div class="metric-label">Total Cost</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
  <div class="metric-value">${((analytics.success_rate || 0) * 100).toFixed(1)}%</div>
  <div class="metric-label">Success Rate</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
  <div class="metric-value">$${(analytics.avg_cost || 0).toFixed(3)}</div>
  <div class="metric-label">Avg Cost</div>
</div>
`
```
:::

:::

## Run Statistics

::: {.grid}

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; text-align: center;">
  <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${analytics.completed_runs || 0}</div>
  <div style="font-size: 0.875rem; color: #6c757d;">Completed</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; text-align: center;">
  <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">${analytics.failed_runs || 0}</div>
  <div style="font-size: 0.875rem; color: #6c757d;">Failed</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; text-align: center;">
  <div style="font-size: 1.5rem; font-weight: bold; color: #6366f1;">${analytics.total_entities || 0}</div>
  <div style="font-size: 0.875rem; color: #6c757d;">Total Entities</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; text-align: center;">
  <div style="font-size: 1.5rem; font-weight: bold; color: #6366f1;">${analytics.total_timepoints || 0}</div>
  <div style="font-size: 0.875rem; color: #6c757d;">Total Timepoints</div>
</div>
`
```
:::

:::

## Cost Analysis

```{ojs}
//| echo: false

cost_chart = {
  const container = html`<div style="height: 400px;"></div>`;

  const costData = analytics.cost_over_time || [];

  if (costData.length === 0) {
    container.innerHTML = '<p style="padding: 2rem; text-align: center;">No cost data available</p>';
    return container;
  }

  setTimeout(() => {
    const chart = echarts.init(container);

    const dates = costData.map(d => d.date).reverse();
    const costs = costData.map(d => d.total_cost).reverse();
    const counts = costData.map(d => d.run_count).reverse();

    chart.setOption({
      title: {
        text: 'Cost Over Time (Last 30 Days)',
        left: 'center',
        textStyle: { fontSize: 18, fontWeight: 'bold' }
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'cross' }
      },
      legend: {
        data: ['Total Cost', 'Run Count'],
        bottom: 10
      },
      xAxis: {
        type: 'category',
        data: dates,
        axisLabel: { rotate: 45 }
      },
      yAxis: [
        {
          type: 'value',
          name: 'Cost ($)',
          position: 'left',
          axisLabel: { formatter: '${value}' }
        },
        {
          type: 'value',
          name: 'Runs',
          position: 'right'
        }
      ],
      series: [
        {
          name: 'Total Cost',
          type: 'bar',
          data: costs,
          itemStyle: { color: '#667eea' }
        },
        {
          name: 'Run Count',
          type: 'line',
          yAxisIndex: 1,
          data: counts,
          itemStyle: { color: '#f5576c' },
          lineStyle: { width: 2 }
        }
      ]
    });

    window.addEventListener('resize', () => chart.resize());
  }, 100);

  return container;
}
```

## Template Performance

```{ojs}
//| echo: false

template_chart = {
  const container = html`<div style="height: 400px;"></div>`;

  const templates = analytics.top_templates || [];

  if (templates.length === 0) {
    container.innerHTML = '<p style="padding: 2rem; text-align: center;">No template data available</p>';
    return container;
  }

  setTimeout(() => {
    const chart = echarts.init(container);

    const templateNames = templates.map(t => t.template_id);
    const templateCounts = templates.map(t => t.count);

    chart.setOption({
      title: {
        text: 'Top Templates by Usage',
        left: 'center',
        textStyle: { fontSize: 18, fontWeight: 'bold' }
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' }
      },
      xAxis: {
        type: 'value'
      },
      yAxis: {
        type: 'category',
        data: templateNames,
        axisLabel: { interval: 0 }
      },
      series: [{
        type: 'bar',
        data: templateCounts,
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
            { offset: 0, color: '#667eea' },
            { offset: 1, color: '#764ba2' }
          ])
        },
        label: {
          show: true,
          position: 'right',
          formatter: '{c} runs'
        }
      }]
    });

    window.addEventListener('resize', () => chart.resize());
  }, 100);

  return container;
}
```

## Causal Mode Distribution

```{ojs}
//| echo: false

causal_chart = {
  const container = html`<div style="height: 400px;"></div>`;

  const modes = analytics.causal_mode_distribution || [];

  if (modes.length === 0) {
    container.innerHTML = '<p style="padding: 2rem; text-align: center;">No causal mode data available</p>';
    return container;
  }

  setTimeout(() => {
    const chart = echarts.init(container);

    chart.setOption({
      title: {
        text: 'Causal Mode Distribution',
        left: 'center',
        textStyle: { fontSize: 18, fontWeight: 'bold' }
      },
      tooltip: {
        trigger: 'item',
        formatter: '{b}: {c} runs ({d}%)'
      },
      legend: {
        orient: 'vertical',
        left: 'left'
      },
      series: [{
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: true,
          formatter: '{b}: {c}'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 16,
            fontWeight: 'bold'
          }
        },
        data: modes.map((m, idx) => ({
          value: m.count,
          name: m.causal_mode,
          itemStyle: {
            color: ['#667eea', '#764ba2', '#f093fb', '#4facfe'][idx % 4]
          }
        }))
      }]
    });

    window.addEventListener('resize', () => chart.resize());
  }, 100);

  return container;
}
```

## Mechanism Co-Occurrence Network

```{ojs}
//| echo: false

html`
<div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
  <strong>Top Mechanism Pairs</strong><br/>
  <small>Mechanisms that frequently appear together in runs</small>
</div>
`

cooccurrence_table = {
  const pairs = analytics.mechanism_co_occurrence || [];

  if (pairs.length === 0) {
    return html`<p style="padding: 2rem; text-align: center;">No co-occurrence data available</p>`;
  }

  return html`<div style="max-height: 400px; overflow-y: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead style="position: sticky; top: 0; background: #f8f9fa;">
        <tr>
          <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Mechanism 1</th>
          <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Mechanism 2</th>
          <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #dee2e6;">Co-Occurrence</th>
        </tr>
      </thead>
      <tbody>
        ${pairs.slice(0, 20).map(p => html`<tr>
          <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">
            <span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">
              ${p.mechanism1}
            </span>
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">
            <span style="background: #764ba2; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">
              ${p.mechanism2}
            </span>
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6; text-align: right; font-weight: 600;">
            ${p.co_occurrence}
          </td>
        </tr>`).join('')}
      </tbody>
    </table>
  </div>`;
}
```

## Causal Graph Convergence

::: {.callout-tip}
Convergence measures agreement in causal graphs across independent simulation runs.
High convergence indicates robust causal mechanisms.
:::

```{ojs}
//| echo: false

// Fetch convergence stats
convergence_stats = {
  try {
    const response = await fetch(`${API_BASE}/api/convergence-stats`);
    if (!response.ok) return { total_sets: 0 };
    return await response.json();
  } catch (e) {
    return { total_sets: 0 };
  }
}
```

::: {.grid}

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
  <div class="metric-value">${convergence_stats.total_sets || 0}</div>
  <div class="metric-label">Convergence Sets</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
  <div class="metric-value">${((convergence_stats.average_score || 0) * 100).toFixed(0)}%</div>
  <div class="metric-label">Avg Convergence</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

// Grade color mapping
grade_color = {
  const grade = (convergence_stats.grade_distribution || {});
  const grades = Object.keys(grade);
  const mostCommon = grades.length > 0 ? grades.sort((a, b) => grade[b] - grade[a])[0] : 'N/A';
  const colors = { 'A': '#10b981', 'B': '#6366f1', 'C': '#f59e0b', 'D': '#f97316', 'F': '#ef4444' };
  return { grade: mostCommon, color: colors[mostCommon] || '#6b7280' };
}

html`
<div class="metric-card" style="background: ${grade_color.color || '#6b7280'};">
  <div class="metric-value">${grade_color.grade}</div>
  <div class="metric-label">Most Common Grade</div>
</div>
`
```
:::

::: {.g-col-6 .g-col-md-3}
```{ojs}
//| echo: false

html`
<div class="metric-card" style="background: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%);">
  <div class="metric-value">${Object.keys(convergence_stats.template_coverage || {}).length}</div>
  <div class="metric-label">Templates Evaluated</div>
</div>
`
```
:::

:::

```{ojs}
//| echo: false

convergence_chart = {
  const container = html`<div style="height: 300px;"></div>`;

  const grade_dist = convergence_stats.grade_distribution || {};

  if (Object.keys(grade_dist).length === 0) {
    container.innerHTML = '<p style="padding: 2rem; text-align: center;">No convergence data available. Run <code>--convergence</code> flag with tests.</p>';
    return container;
  }

  setTimeout(() => {
    const chart = echarts.init(container);

    const grades = ['A', 'B', 'C', 'D', 'F'];
    const colors = ['#10b981', '#6366f1', '#f59e0b', '#f97316', '#ef4444'];

    chart.setOption({
      title: {
        text: 'Convergence Grade Distribution',
        left: 'center',
        textStyle: { fontSize: 16, fontWeight: 'bold' }
      },
      tooltip: { trigger: 'item' },
      xAxis: {
        type: 'category',
        data: grades
      },
      yAxis: { type: 'value', name: 'Count' },
      series: [{
        type: 'bar',
        data: grades.map((g, idx) => ({
          value: grade_dist[g] || 0,
          itemStyle: { color: colors[idx] }
        })),
        label: { show: true, position: 'top' }
      }]
    });

    window.addEventListener('resize', () => chart.resize());
  }, 100);

  return container;
}
```
