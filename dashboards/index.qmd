---
title: "Timepoint Simulation Dashboard"
format:
  html:
    page-layout: full
    code-tools: false
    code-fold: false
---

```{ojs}
//| echo: false

// ==============================================================================
// DATA LOADING & STATE MANAGEMENT
// ==============================================================================

API_BASE = "http://localhost:8000"

// URL parameter extraction
urlParams = new URLSearchParams(window.location.search)
runIdFromUrl = urlParams.get('run_id')

// State management from URL
initialDepth = parseInt(urlParams.get('depth') || '1')
initialEntities = urlParams.get('entities') ? urlParams.get('entities').split(',') : null
initialMechanisms = urlParams.get('mechanisms') ? urlParams.get('mechanisms').split(',') : null
jumpToTimepoint = urlParams.get('tp')

// Load static data
staticData = FileAttachment("dashboard_data.json").json()

// Fetch run data from API
displayRun = runIdFromUrl
  ? await (async () => {
      try {
        const response = await fetch(`${API_BASE}/api/run/${runIdFromUrl}`);
        if (!response.ok) throw new Error('Run not found');
        const runDetails = await response.json();

        // Fetch narrative
        try {
          const narrativeResp = await fetch(`${API_BASE}/api/narrative/${runIdFromUrl}`);
          if (narrativeResp.ok) {
            runDetails.narrative = await narrativeResp.json();
          }
        } catch (e) {
          console.log('No narrative available');
        }

        return runDetails;
      } catch (error) {
        console.error('Error fetching run:', error);
        return null;
      }
    })()
  : (await staticData).selected_run

// Extract timepoints and entities
timepoints = displayRun?.narrative?.timepoints || displayRun?.narrative?.timeline || []
allEntities = {
  const entitySet = new Set();
  timepoints.forEach(tp => {
    const entities = tp.entities_present || tp.entities || [];
    entities.forEach(e => entitySet.add(e));
  });
  return Array.from(entitySet).sort();
}

// Mechanism data
mechanismsUsed = displayRun?.mechanism_usage || []
resolutionAssignments = displayRun?.resolution_assignments || []
validations = displayRun?.validations || []
```

```{ojs}
//| echo: false

// ==============================================================================
// STATE MANAGEMENT FUNCTIONS
// ==============================================================================

// Mutable state
mutable depthLevel = initialDepth
mutable selectedEntitiesSet = new Set(initialEntities || allEntities)
mutable activeMechanisms = new Set(initialMechanisms || ['fidelity', 'causality', 'embodiment'])

// URL state update function
function updateURLState() {
  const params = new URLSearchParams();
  params.set('run_id', runIdFromUrl);
  params.set('depth', mutable depthLevel);
  if (mutable selectedEntitiesSet.size < allEntities.length) {
    params.set('entities', Array.from(mutable selectedEntitiesSet).join(','));
  }
  if (mutable activeMechanisms.size > 0 && mutable activeMechanisms.size < 10) {
    params.set('mechanisms', Array.from(mutable activeMechanisms).join(','));
  }
  const newUrl = `${window.location.pathname}?${params.toString()}`;
  window.history.pushState({}, '', newUrl);
}

// Depth change handler
function setDepth(level) {
  mutable depthLevel = level;
  updateURLState();
  requestAnimationFrame(() => {
    renderTimeline();
  });
}

// Entity toggle handler
function toggleEntity(entity) {
  if (mutable selectedEntitiesSet.has(entity)) {
    mutable selectedEntitiesSet.delete(entity);
  } else {
    mutable selectedEntitiesSet.add(entity);
  }
  mutable selectedEntitiesSet = new Set(mutable selectedEntitiesSet);
  updateURLState();
  requestAnimationFrame(() => {
    renderTimeline();
  });
}

// Mechanism toggle handler
function toggleMechanism(mech) {
  if (mutable activeMechanisms.has(mech)) {
    mutable activeMechanisms.delete(mech);
  } else {
    mutable activeMechanisms.add(mech);
  }
  mutable activeMechanisms = new Set(mutable activeMechanisms);
  updateURLState();
  requestAnimationFrame(() => {
    renderTimeline();
  });
}
```

```{ojs}
//| echo: false

// ==============================================================================
// NAVIGATION & METADATA
// ==============================================================================

navLinks = runIdFromUrl
  ? html`<div class="nav-header">
      <div class="nav-links">
        <a href="runs.html">‚Üê All Runs</a>
        <span class="divider">|</span>
        <a href="analytics.html">Analytics</a>
        <span class="divider">|</span>
        <a href="screenplay.html?run_id=${runIdFromUrl}">üìÑ Screenplay</a>
        <span class="divider">|</span>
        <a href="dialogs.html?run_id=${runIdFromUrl}">üí¨ Dialogs</a>
        <button onclick="window.location.reload()" class="refresh-btn">üîÑ Refresh</button>
      </div>
    </div>`
  : html`<div class="nav-header">
      <div class="nav-links">
        <a href="runs.html">‚Üê All Runs</a>
        <span class="divider">|</span>
        <a href="analytics.html">Analytics</a>
      </div>
    </div>`

metadata_summary = html`
  <div class="metadata-summary">
    <div class="meta-grid">
      <div class="meta-card">
        <div class="meta-label">Run ID</div>
        <div class="meta-value"><code>${displayRun?.run_id || 'N/A'}</code></div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Template</div>
        <div class="meta-value">${displayRun?.template_id || 'N/A'}</div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Mode</div>
        <div class="meta-value mode-${displayRun?.causal_mode}">${(displayRun?.causal_mode || 'N/A').toUpperCase()}</div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Entities</div>
        <div class="meta-value value-entities">${displayRun?.entities_created || 0}</div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Timepoints</div>
        <div class="meta-value value-timepoints">${displayRun?.timepoints_created || 0}</div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Cost</div>
        <div class="meta-value">$${displayRun?.cost_usd?.toFixed(3) || '0.000'}</div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Tokens</div>
        <div class="meta-value">${displayRun?.tokens_used ? Math.round(displayRun.tokens_used / 1000) + 'k' : '0'}</div>
      </div>
      <div class="meta-card">
        <div class="meta-label">Duration</div>
        <div class="meta-value">${displayRun?.duration_seconds ? Math.round(displayRun.duration_seconds) + 's' : 'N/A'}</div>
      </div>
    </div>

    ${displayRun?.narrative?.executive_summary ? html`
      <div class="executive-summary">
        <div class="summary-label">Executive Summary</div>
        <div class="summary-text">${displayRun.narrative.executive_summary}</div>
      </div>
    ` : ''}

    ${validations && validations.length > 0 ? html`
      <div class="validations-summary">
        <div class="summary-label">Validations</div>
        <div class="validation-list">
          ${validations.map(v => html`
            <div class="validation-item ${v.passed ? 'validation-pass' : 'validation-fail'}">
              <div class="validation-header">
                <span class="validation-icon">${v.passed ? '‚úÖ' : '‚ùå'}</span>
                <span class="validation-name">${v.validator_name}</span>
              </div>
              ${v.message ? html`<div class="validation-message">${v.message}</div>` : ''}
              ${v.violations ? html`<div class="validation-violations">Violations: ${v.violations}</div>` : ''}
            </div>
          `)}
        </div>
      </div>
    ` : ''}
  </div>
`
```

```{ojs}
//| echo: false

// ==============================================================================
// CONTROL DASHBOARD (STICKY HEADER)
// ==============================================================================

controlDashboard = {
  if (!runIdFromUrl || timepoints.length === 0) return html`<div></div>`;

  const depthButtons = [
    { level: 0, label: 'Spine', desc: 'Overview' },
    { level: 1, label: 'Events', desc: 'Descriptions' },
    { level: 2, label: 'Entities', desc: 'Participation' },
    { level: 3, label: 'Mechanisms', desc: 'Data' },
    { level: 4, label: 'State', desc: 'Context' },
    { level: 5, label: 'Dialog', desc: 'Conversations' }
  ];

  const container = html`<div class="control-dashboard">
    <div class="control-section">
      <div class="control-label">Depth</div>
      <div class="depth-controls">
        ${depthButtons.map(btn => {
          const button = html`<button class="depth-btn ${mutable depthLevel === btn.level ? 'active' : ''}" title="${btn.desc}">${btn.label}</button>`;
          button.onclick = () => setDepth(btn.level);
          return button;
        })}
      </div>
    </div>

    ${allEntities.length > 0 ? html`
      <div class="control-section">
        <div class="control-label">Entities</div>
        <div class="entity-filters">
          ${allEntities.map(entity => {
            const icon = entityIcons[entity.toLowerCase()] || 'üë§';
            const isActive = mutable selectedEntitiesSet.has(entity);
            const button = html`<button class="entity-filter ${isActive ? 'active' : ''}">
              <span class="entity-icon">${icon}</span>
              <span class="entity-name">${entity}</span>
            </button>`;
            button.onclick = () => toggleEntity(entity);
            return button;
          })}
        </div>
      </div>
    ` : ''}

    ${mutable depthLevel >= 3 ? html`
      <div class="control-section">
        <div class="control-label">Mechanisms</div>
        <div class="mechanism-filters">
          ${['fidelity', 'causality', 'embodiment', 'dialog', 'tensor', 'generation'].map(mech => {
            const isActive = mutable activeMechanisms.has(mech);
            const button = html`<button class="mech-filter ${isActive ? 'active' : ''}">${mech}</button>`;
            button.onclick = () => toggleMechanism(mech);
            return button;
          })}
        </div>
      </div>
    ` : ''}
  </div>`;

  return container;
}
```

```{ojs}
//| echo: false

// ==============================================================================
// SHARED DATA & CONFIGURATION
// ==============================================================================

// Entity icon mapping (shared across all rendering functions)
entityIcons = {
  return {
    'customers': 'üë•',
    'timepoint': 'üè¢',
    'ken': 'üë®‚Äçüíº',
    'sean': 'üë®‚Äçüíº'
  };
}

// Semantic mechanism labels (M1-M17 contextual naming)
mechanismLabels = {
  return {
    'M1': 'Fidelity',
    'M2': 'Progressive Training',
    'M3': 'Exposure Tracking',
    'M4': 'Physics Validation',
    'M5': 'Query Resolution',
    'M6': 'Tensor Model',
    'M7': 'Causality',
    'M8': 'Embodiment',
    'M9': 'On-Demand Generation',
    'M10': 'Scene Context',
    'M11': 'Dialog Synthesis',
    'M12': 'Counterfactuals',
    'M13': 'Multi-Entity',
    'M14': 'Circadian Patterns',
    'M15': 'Prospection',
    'M16': 'Animism',
    'M17': 'Temporal Mode'
  };
}

// Mechanism color coding by category
mechanismColors = {
  return {
    'M1': '#6366f1',  // Fidelity - indigo
    'M2': '#6366f1',  // Training - indigo
    'M5': '#6366f1',  // Query - indigo
    'M6': '#8b5cf6',  // Tensor - purple
    'M7': '#ec4899',  // Causality - pink
    'M8': '#f59e0b',  // Embodiment - amber
    'M3': '#10b981',  // Exposure - emerald
    'M4': '#10b981',  // Validation - emerald
    'M9': '#0ea5e9',  // Generation - sky
    'M10': '#0ea5e9', // Scene - sky
    'M11': '#8b5cf6', // Dialog - purple
    'M12': '#ec4899', // Counterfactual - pink
    'M13': '#a855f7', // Multi-entity - fuchsia
    'M14': '#f59e0b', // Circadian - amber
    'M15': '#06b6d4', // Prospection - cyan
    'M16': '#84cc16', // Animism - lime
    'M17': '#ef4444'  // Temporal - red
  };
}

// Render mechanisms for a timepoint
renderMechanisms = (tp, tpIdx) => {
  // Get mechanisms active at this timepoint from run data
  const tpMechanisms = mechanismsUsed.filter(m => {
    // Match by timepoint context or index
    return m.context && (m.context.includes(tp.timepoint_id) || m.context.includes(`tp_${tpIdx}`));
  });

  if (tpMechanisms.length === 0) {
    return html`<div class="mech-empty">No mechanism data tracked for this timepoint</div>`;
  }

  // Group mechanisms by type
  const mechCounts = {};
  tpMechanisms.forEach(m => {
    const mechId = m.mechanism.toUpperCase();
    if (!mechCounts[mechId]) {
      mechCounts[mechId] = { count: 0, functions: new Set() };
    }
    mechCounts[mechId].count++;
    if (m.function_name) {
      mechCounts[mechId].functions.add(m.function_name);
    }
  });

  // Filter by active mechanisms
  const activeFilter = Array.from(mutable activeMechanisms);
  const filteredMechs = Object.entries(mechCounts).filter(([mechId, data]) => {
    if (activeFilter.length === 0) return true;
    const label = mechanismLabels[mechId]?.toLowerCase() || '';
    return activeFilter.some(filter => label.includes(filter) || mechId.toLowerCase().includes(filter));
  });

  if (filteredMechs.length === 0) {
    return html`<div class="mech-empty">No active mechanisms match current filters</div>`;
  }

  return html`
    <div class="mech-grid">
      ${filteredMechs.map(([mechId, data]) => {
        const label = mechanismLabels[mechId] || mechId;
        const color = mechanismColors[mechId] || '#64748b';
        const functions = Array.from(data.functions);

        return html`
          <div class="mech-card" style="border-left-color: ${color};">
            <div class="mech-header">
              <span class="mech-id" style="color: ${color};">${mechId}</span>
              <span class="mech-label">${label}</span>
              <span class="mech-count">${data.count}√ó</span>
            </div>
            ${functions.length > 0 ? html`
              <div class="mech-functions">
                ${functions.slice(0, 3).map(fn => html`
                  <code class="mech-fn">${fn}</code>
                `)}
                ${functions.length > 3 ? html`<span class="mech-more">+${functions.length - 3} more</span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      })}
    </div>
  `;
}

// Render entity states (physical & cognitive tensors)
renderEntityStates = (tp, entities) => {
  // Get resolution assignments for this timepoint
  const tpResolutions = resolutionAssignments.filter(r =>
    r.timepoint_id === tp.timepoint_id
  );

  if (tpResolutions.length === 0 && (!tp.entity_states || tp.entity_states.length === 0)) {
    return html`<div class="state-empty">No state data available for this timepoint</div>`;
  }

  // Build state cards for each entity
  const stateCards = entities.map(entityId => {
    // Find resolution for this entity
    const resolution = tpResolutions.find(r => r.entity_id === entityId);

    // Get entity state data from timepoint if available
    const entityState = tp.entity_states?.find(s => s.entity_id === entityId);

    return html`
      <div class="state-card">
        <div class="state-entity">
          <span class="state-icon">${entityIcons[entityId.toLowerCase()] || 'üë§'}</span>
          <span class="state-name">${entityId}</span>
          ${resolution ? html`
            <span class="state-resolution resolution-${resolution.resolution.toLowerCase()}">
              ${resolution.resolution}
            </span>
          ` : ''}
        </div>

        ${entityState ? html`
          <div class="state-tensors">
            <!-- Physical Tensor -->
            ${entityState.physical ? html`
              <div class="tensor-section">
                <div class="tensor-label">
                  <span class="tensor-icon">üèÉ</span>
                  Physical
                </div>
                <div class="tensor-grid">
                  ${entityState.physical.age !== undefined ? html`
                    <div class="tensor-field">
                      <span class="field-key">Age</span>
                      <span class="field-value">${entityState.physical.age}</span>
                    </div>
                  ` : ''}
                  ${entityState.physical.health_status ? html`
                    <div class="tensor-field">
                      <span class="field-key">Health</span>
                      <span class="field-value">${entityState.physical.health_status}</span>
                    </div>
                  ` : ''}
                  ${entityState.physical.location ? html`
                    <div class="tensor-field">
                      <span class="field-key">Location</span>
                      <span class="field-value">${entityState.physical.location}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}

            <!-- Cognitive Tensor -->
            ${entityState.cognitive ? html`
              <div class="tensor-section">
                <div class="tensor-label">
                  <span class="tensor-icon">üß†</span>
                  Cognitive
                </div>
                <div class="tensor-grid">
                  ${entityState.cognitive.emotional_valence !== undefined ? html`
                    <div class="tensor-field">
                      <span class="field-key">Emotion</span>
                      <span class="field-value">${(entityState.cognitive.emotional_valence * 100).toFixed(0)}%</span>
                    </div>
                  ` : ''}
                  ${entityState.cognitive.energy_budget !== undefined ? html`
                    <div class="tensor-field">
                      <span class="field-key">Energy</span>
                      <span class="field-value">${(entityState.cognitive.energy_budget * 100).toFixed(0)}%</span>
                    </div>
                  ` : ''}
                  ${entityState.cognitive.knowledge_state ? html`
                    <div class="tensor-field">
                      <span class="field-key">Knowledge</span>
                      <span class="field-value">${entityState.cognitive.knowledge_state.length} items</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}
          </div>
        ` : html`
          <div class="state-placeholder">
            <span class="placeholder-text">State data available at resolution: ${resolution?.resolution || 'SCENE'}</span>
          </div>
        `}
      </div>
    `;
  });

  return html`<div class="state-grid">${stateCards}</div>`;
}

// Render dialogs for a timepoint
renderDialogs = (tp, tpIdx) => {
  // Get dialogs from timepoint data or from displayRun.dialogs
  const tpDialogs = tp.dialogs || [];

  if (tpDialogs.length === 0) {
    return html`<div class="dialog-empty">No conversations recorded at this timepoint</div>`;
  }

  return html`
    <div class="dialog-list">
      ${tpDialogs.map((dialog, dialogIdx) => {
        const speakers = dialog.participants || [];
        const turns = dialog.turns || [];

        return html`
          <div class="dialog-card">
            <div class="dialog-header">
              <div class="dialog-participants">
                ${speakers.map(speaker => html`
                  <span class="participant-badge">
                    <span class="badge-icon">${entityIcons[speaker.toLowerCase()] || 'üë§'}</span>
                    ${speaker}
                  </span>
                `)}
              </div>
              <span class="dialog-turn-count">${turns.length} turns</span>
            </div>

            <div class="dialog-transcript">
              ${turns.slice(0, 5).map((turn, turnIdx) => html`
                <div class="dialog-turn">
                  <div class="turn-speaker">
                    <span class="speaker-icon">${entityIcons[turn.speaker?.toLowerCase()] || 'üë§'}</span>
                    <span class="speaker-name">${turn.speaker}</span>
                    ${turn.emotional_tone ? html`
                      <span class="speaker-emotion">(${turn.emotional_tone})</span>
                    ` : ''}
                  </div>
                  <div class="turn-content">${turn.content}</div>
                  ${turn.knowledge_references && turn.knowledge_references.length > 0 ? html`
                    <div class="turn-knowledge">
                      <span class="knowledge-icon">üí°</span>
                      <span class="knowledge-text">${turn.knowledge_references.join(', ')}</span>
                    </div>
                  ` : ''}
                </div>
              `)}
              ${turns.length > 5 ? html`
                <div class="dialog-more">
                  <span class="more-text">+ ${turns.length - 5} more turns</span>
                </div>
              ` : ''}
            </div>

            ${dialog.information_exchanged && dialog.information_exchanged.length > 0 ? html`
              <div class="dialog-summary">
                <div class="summary-label">Information Exchanged</div>
                <div class="summary-items">
                  ${dialog.information_exchanged.slice(0, 3).map(info => html`
                    <span class="info-item">${info}</span>
                  `)}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      })}
    </div>
  `;
}
```

```{ojs}
//| echo: false

// ==============================================================================
// VERTICAL TIMELINE RENDERING
// ==============================================================================

renderTimeline = () => {
  if (!runIdFromUrl || timepoints.length === 0) {
    return html`<div class="empty-state">
      <div class="empty-icon">‚è±Ô∏è</div>
      <div class="empty-title">No timeline data available</div>
      <div class="empty-subtitle">
        ${displayRun?.timepoints_created > 0
          ? 'Run has data in database but narrative not exported'
          : 'Select a run with timeline data to visualize'}
      </div>
    </div>`;
  }

  // Importance color mapping
  const getImportanceColor = (importance) => {
    if (importance >= 0.7) return { primary: '#6366f1', secondary: '#8b5cf6', name: 'high' };
    if (importance >= 0.4) return { primary: '#667eea', secondary: '#764ba2', name: 'medium' };
    return { primary: '#64748b', secondary: '#475569', name: 'low' };
  };

  // Calculate timeline height
  const timelineHeight = timepoints.length * 600 + 200;
  const spineX = 240; // Desktop spine position

  // Build timepoint cards
  const cards = timepoints.map((tp, idx) => {
    const importance = tp.importance !== undefined ? tp.importance : 0.5;
    const colors = getImportanceColor(importance);
    const entities = tp.entities_present || tp.entities || [];
    const filteredEntities = entities.filter(e => mutable selectedEntitiesSet.has(e));

    if (filteredEntities.length === 0 && mutable selectedEntitiesSet.size < allEntities.length) {
      return null; // Skip if no entities match filter
    }

    const cardY = idx * 600 + 100;
    const isLeft = idx % 2 === 0;

    return html`
      <div
        class="timepoint-card depth-${mutable depthLevel} ${isLeft ? 'left' : 'right'}"
        style="top: ${cardY}px;"
        data-tp="${tp.timepoint_id}"
        data-index="${idx}"
      >
        <div class="card-connector" style="background: ${colors.primary};"></div>

        <!-- Level 0: Just the node marker -->
        <div class="tp-spine-marker">
          <div class="node-circle" style="background: linear-gradient(135deg, ${colors.primary}, ${colors.secondary});"></div>
          <div class="node-label">${tp.timepoint_id || `T${idx + 1}`}</div>
        </div>

        <!-- Level 1+: Event info -->
        ${mutable depthLevel >= 1 ? html`
          <div class="tp-event-info">
            <h3 class="event-title">${tp.timepoint_id || `Timepoint ${idx + 1}`}</h3>
            <time class="event-time">${new Date(tp.timestamp).toLocaleString()}</time>
            <p class="event-description">${tp.event_description || 'No description'}</p>
            ${tp.importance !== undefined ? html`
              <div class="importance-indicator">
                <span class="importance-label">Importance</span>
                <div class="importance-bar">
                  <div class="importance-fill importance-${colors.name}" style="width: ${importance * 100}%"></div>
                </div>
                <span class="importance-value">${(importance * 100).toFixed(0)}%</span>
              </div>
            ` : ''}
          </div>
        ` : ''}

        <!-- Level 2+: Entities -->
        ${mutable depthLevel >= 2 && filteredEntities.length > 0 ? html`
          <div class="tp-entities">
            <div class="section-label">Entities Present</div>
            <div class="entity-badges">
              ${filteredEntities.map(entity => html`
                <span class="entity-badge">
                  <span class="badge-icon">${entityIcons[entity.toLowerCase()] || 'üë§'}</span>
                  <span class="badge-name">${entity}</span>
                </span>
              `)}
            </div>
          </div>
        ` : ''}

        <!-- Level 3+: Mechanisms -->
        ${mutable depthLevel >= 3 ? html`
          <div class="tp-mechanisms">
            <div class="section-label">Mechanisms</div>
            ${renderMechanisms(tp, idx)}
          </div>
        ` : ''}

        <!-- Level 4+: State -->
        ${mutable depthLevel >= 4 ? html`
          <div class="tp-state">
            <div class="section-label">Entity States</div>
            ${renderEntityStates(tp, filteredEntities)}
          </div>
        ` : ''}

        <!-- Level 5+: Dialog -->
        ${mutable depthLevel >= 5 ? html`
          <div class="tp-dialog">
            <div class="section-label">Conversations</div>
            ${renderDialogs(tp, idx)}
          </div>
        ` : ''}
      </div>
    `;
  }).filter(card => card !== null);

  // Build SVG spine with entity tracer lines
  const svgWidth = 480;
  const spineLineColor = '#475569';

  // Entity tracer paths
  const entityPaths = allEntities.map((entity, entityIdx) => {
    if (!mutable selectedEntitiesSet.has(entity)) return null;

    const entityColor = {
      'customers': '#ec4899',
      'timepoint': '#0ea5e9',
      'ken': '#8b5cf6',
      'sean': '#22c55e'
    }[entity.toLowerCase()] || '#94a3b8';

    // Build path through timepoints where entity is present
    let pathData = '';
    let lastY = null;

    timepoints.forEach((tp, idx) => {
      const entities = tp.entities_present || tp.entities || [];
      if (entities.includes(entity)) {
        const y = idx * 600 + 100;
        if (lastY === null) {
          pathData += `M ${spineX + (entityIdx - allEntities.length/2) * 8} ${y} `;
        } else {
          pathData += `L ${spineX + (entityIdx - allEntities.length/2) * 8} ${y} `;
        }
        lastY = y;
      }
    });

    if (!pathData) return null;

    return html`<path
      class="entity-tracer"
      d="${pathData}"
      stroke="${entityColor}"
      stroke-width="2"
      fill="none"
      opacity="0.3"
      data-entity="${entity}"
    />`;
  }).filter(p => p !== null);

  return html`
    <div class="timeline-container">
      <svg class="timeline-spine" width="${svgWidth}" height="${timelineHeight}">
        <!-- Main spine line -->
        <line
          x1="${spineX}"
          y1="0"
          x2="${spineX}"
          y2="${timelineHeight}"
          stroke="${spineLineColor}"
          stroke-width="4"
          class="spine-line"
        />

        <!-- Entity tracer lines -->
        ${entityPaths}

        <!-- Timepoint nodes -->
        ${timepoints.map((tp, idx) => {
          const importance = tp.importance !== undefined ? tp.importance : 0.5;
          const colors = getImportanceColor(importance);
          const y = idx * 600 + 100;

          return html`<g>
            <defs>
              <linearGradient id="grad-${idx}" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:${colors.primary};stop-opacity:1" />
                <stop offset="100%" style="stop-color:${colors.secondary};stop-opacity:1" />
              </linearGradient>
            </defs>
            <circle
              cx="${spineX}"
              cy="${y}"
              r="16"
              fill="url(#grad-${idx})"
              stroke="${colors.primary}"
              stroke-width="3"
              class="spine-node"
              data-index="${idx}"
            />
          </g>`;
        })}
      </svg>

      <div class="timeline-cards">
        ${cards}
      </div>

      <!-- Navigation sidebar -->
      <div class="timeline-nav">
        <div class="nav-title">Timeline</div>
        ${timepoints.map((tp, idx) => {
          const importance = tp.importance !== undefined ? tp.importance : 0.5;
          const link = html`
            <a
              href="#tp-${idx}"
              class="nav-item"
              data-index="${idx}"
            >
              <span class="nav-label">${tp.timepoint_id || `T${idx+1}`}</span>
              <div class="nav-importance-bar" style="width: ${importance * 100}%"></div>
            </a>
          `;
          // Add smooth scroll behavior
          link.onclick = (e) => {
            e.preventDefault();
            const targetCard = document.querySelector(`.timepoint-card[data-index="${idx}"]`);
            if (targetCard) {
              targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          };
          return link;
        })}
      </div>
    </div>
  `;
}
```

```{ojs}
//| echo: false

// ==============================================================================
// RENDER OUTPUT
// ==============================================================================

html`${navLinks}`
html`${metadata_summary}`
html`${controlDashboard}`
html`${renderTimeline()}`
```

<style>
/* ==========================================================================
   VERTICAL TIMELINE DASHBOARD STYLES
   Contemporary, Geometric, Playful
   ========================================================================== */

:root {
  /* Color system */
  --color-bg-primary: #0f172a;
  --color-bg-secondary: #1e293b;
  --color-bg-tertiary: #334155;
  --color-text-primary: #f8fafc;
  --color-text-secondary: #cbd5e1;
  --color-text-muted: #94a3b8;
  --color-border: #475569;
  --color-accent: #6366f1;
  --color-accent-secondary: #8b5cf6;

  /* Importance colors */
  --color-importance-high-1: #6366f1;
  --color-importance-high-2: #8b5cf6;
  --color-importance-medium-1: #667eea;
  --color-importance-medium-2: #764ba2;
  --color-importance-low-1: #64748b;
  --color-importance-low-2: #475569;

  /* Entity colors */
  --color-entity-customers: #ec4899;
  --color-entity-timepoint: #0ea5e9;
  --color-entity-ken: #8b5cf6;
  --color-entity-sean: #22c55e;

  /* Spacing */
  --spacing-unit: 8px;
  --spine-x-desktop: 240px;
  --spine-x-mobile: 80px;
  --card-width: 480px;
  --card-gap: 80px;
}

* {
  box-sizing: border-box;
}

body {
  background: var(--color-bg-primary);
  color: var(--color-text-primary);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 16px;
  line-height: 1.6;
  margin: 0;
  padding: 0;
}

code {
  font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
  font-size: 0.875em;
  background: rgba(99, 102, 241, 0.1);
  padding: 0.2em 0.4em;
  border-radius: 4px;
}

/* ==========================================================================
   NAVIGATION HEADER
   ========================================================================== */

.nav-header {
  background: var(--color-bg-secondary);
  border-bottom: 1px solid var(--color-border);
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  z-index: 100;
}

.nav-links {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.nav-links a {
  color: var(--color-text-secondary);
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s;
}

.nav-links a:hover {
  color: var(--color-accent);
}

.nav-links .divider {
  color: var(--color-border);
}

.refresh-btn {
  margin-left: auto;
  background: var(--color-accent);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

.refresh-btn:hover {
  background: #4f46e5;
}

/* ==========================================================================
   METADATA SUMMARY
   ========================================================================== */

.metadata-summary {
  padding: 2rem;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
  border-bottom: 1px solid var(--color-border);
}

.meta-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.meta-card {
  background: var(--color-bg-secondary);
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid var(--color-border);
}

.meta-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.meta-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
}

.meta-value code {
  font-size: 0.875rem;
}

.value-entities {
  color: var(--color-accent);
}

.value-timepoints {
  color: var(--color-accent-secondary);
}

.mode-portal {
  color: #ec4899;
  text-transform: uppercase;
}

.executive-summary {
  background: var(--color-bg-secondary);
  padding: 1.5rem;
  border-radius: 8px;
  border-left: 4px solid var(--color-accent);
}

.summary-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-accent-secondary);
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.summary-text {
  color: var(--color-text-secondary);
  line-height: 1.8;
}

/* Validations summary */
.validations-summary {
  background: var(--color-bg-secondary);
  padding: 1.5rem;
  border-radius: 8px;
  border-left: 4px solid var(--color-accent);
  margin-top: 2rem;
}

.validation-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
}

.validation-item {
  background: var(--color-bg-tertiary);
  border-radius: 6px;
  padding: 1rem;
  border-left: 3px solid;
  transition: all 0.2s;
}

.validation-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.validation-pass {
  border-left-color: #10b981;
}

.validation-fail {
  border-left-color: #ef4444;
}

.validation-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.5rem;
}

.validation-icon {
  font-size: 1.25rem;
}

.validation-name {
  font-weight: 600;
  color: var(--color-text-primary);
  font-size: 0.875rem;
  flex: 1;
}

.validation-message {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  margin-top: 0.5rem;
  line-height: 1.6;
}

.validation-violations {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: #ef4444;
  margin-top: 0.5rem;
  padding: 0.25rem 0.5rem;
  background: rgba(239, 68, 68, 0.1);
  border-radius: 4px;
  display: inline-block;
}

/* ==========================================================================
   CONTROL DASHBOARD (STICKY)
   ========================================================================== */

.control-dashboard {
  position: sticky;
  top: 73px;
  z-index: 90;
  background: var(--color-bg-secondary);
  border-bottom: 2px solid var(--color-accent);
  padding: 1rem 2rem;
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
  align-items: center;
}

.control-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.control-label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
}

.depth-controls {
  display: flex;
  gap: 0.5rem;
}

.depth-btn {
  background: var(--color-bg-tertiary);
  color: var(--color-text-secondary);
  border: 2px solid transparent;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s;
}

.depth-btn:hover {
  border-color: var(--color-accent);
  color: var(--color-text-primary);
}

.depth-btn.active {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-accent);
}

.entity-filters, .mechanism-filters {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.entity-filter, .mech-filter {
  background: var(--color-bg-tertiary);
  color: var(--color-text-secondary);
  border: 2px solid transparent;
  padding: 0.4rem 0.75rem;
  border-radius: 2rem;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.entity-filter:hover, .mech-filter:hover {
  border-color: var(--color-accent);
}

.entity-filter.active, .mech-filter.active {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-accent);
}

.entity-icon {
  font-size: 1.1em;
}

/* ==========================================================================
   VERTICAL TIMELINE
   ========================================================================== */

.timeline-container {
  position: relative;
  padding: 2rem 0;
  min-height: 100vh;
}

.timeline-spine {
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
}

.spine-line {
  transition: stroke 0.3s;
}

.spine-node {
  cursor: pointer;
  pointer-events: all;
  transition: all 0.2s;
}

.spine-node:hover {
  r: 20;
  filter: drop-shadow(0 0 8px currentColor);
}

.entity-tracer {
  stroke-dasharray: 4 4;
  animation: dash 20s linear infinite;
}

@keyframes dash {
  to {
    stroke-dashoffset: -100;
  }
}

.timeline-cards {
  position: relative;
  margin-left: var(--spine-x-desktop);
  padding-left: var(--card-gap);
  padding-right: var(--card-gap);
}

.timepoint-card {
  position: absolute;
  width: var(--card-width);
  background: var(--color-bg-secondary);
  border: 2px solid var(--color-border);
  border-radius: 12px;
  padding: 2rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform-origin: left center;
}

.timepoint-card.left {
  left: var(--card-gap);
  transform: translateX(0);
}

.timepoint-card.right {
  right: var(--card-gap);
  left: auto;
  transform: translateX(0);
}

.timepoint-card:hover {
  border-color: var(--color-accent);
  box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
  transform: translateY(-4px);
}

.card-connector {
  position: absolute;
  left: -var(--card-gap);
  top: 32px;
  width: var(--card-gap);
  height: 4px;
  background: var(--color-accent);
}

.timepoint-card.right .card-connector {
  left: auto;
  right: -var(--card-gap);
}

.tp-spine-marker {
  position: absolute;
  left: calc(-1 * var(--card-gap) - 32px);
  top: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.timepoint-card.right .tp-spine-marker {
  left: auto;
  right: calc(-1 * var(--card-gap) - 32px);
}

.node-circle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 3px solid var(--color-accent);
}

.node-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--color-text-muted);
  text-align: center;
}

/* Event info styles */
.tp-event-info {
  margin-top: 1rem;
}

.event-title {
  font-size: 2rem;
  font-weight: 800;
  color: var(--color-text-primary);
  margin: 0 0 0.5rem 0;
}

.event-time {
  display: block;
  font-size: 0.875rem;
  color: var(--color-text-muted);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 1rem;
}

.event-description {
  color: var(--color-text-secondary);
  line-height: 1.8;
  margin: 0 0 1.5rem 0;
}

.importance-indicator {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
}

.importance-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--color-text-muted);
}

.importance-bar {
  flex: 1;
  height: 8px;
  background: var(--color-bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}

.importance-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s;
}

.importance-fill.importance-high {
  background: linear-gradient(90deg, var(--color-importance-high-1), var(--color-importance-high-2));
}

.importance-fill.importance-medium {
  background: linear-gradient(90deg, var(--color-importance-medium-1), var(--color-importance-medium-2));
}

.importance-fill.importance-low {
  background: linear-gradient(90deg, var(--color-importance-low-1), var(--color-importance-low-2));
}

.importance-value {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--color-text-primary);
  min-width: 3em;
  text-align: right;
}

/* Entities styles */
.tp-entities {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--color-border);
}

.section-label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
  margin-bottom: 0.75rem;
}

.entity-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.entity-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 2rem;
  font-weight: 600;
  font-size: 0.875rem;
}

/* ==========================================================================
   DEPTH 3: MECHANISMS
   ========================================================================== */

.tp-mechanisms {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--color-border);
}

.mech-empty, .state-empty, .dialog-empty {
  color: var(--color-text-muted);
  font-style: italic;
  padding: 1rem;
  text-align: center;
  background: rgba(99, 102, 241, 0.05);
  border-radius: 8px;
}

.mech-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 1rem;
}

.mech-card {
  background: var(--color-bg-tertiary);
  border-left: 4px solid var(--color-accent);
  border-radius: 8px;
  padding: 1rem;
  transition: all 0.2s;
}

.mech-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.mech-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.mech-id {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.875rem;
  font-weight: 700;
}

.mech-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary);
  flex: 1;
}

.mech-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--color-text-muted);
  background: var(--color-bg-primary);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}

.mech-functions {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.mech-fn {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  background: var(--color-bg-primary);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}

.mech-more {
  font-size: 0.75rem;
  color: var(--color-text-muted);
  font-style: italic;
  margin-top: 0.25rem;
}

/* ==========================================================================
   DEPTH 4: STATE TENSORS
   ========================================================================== */

.tp-state {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--color-border);
}

.state-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
}

.state-card {
  background: var(--color-bg-tertiary);
  border-radius: 8px;
  padding: 1rem;
  border: 1px solid var(--color-border);
}

.state-entity {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--color-border);
}

.state-icon {
  font-size: 1.5rem;
}

.state-name {
  font-weight: 700;
  color: var(--color-text-primary);
  flex: 1;
}

.state-resolution {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  text-transform: uppercase;
}

.resolution-tensor_only {
  background: rgba(100, 116, 139, 0.2);
  color: #94a3b8;
}

.resolution-scene {
  background: rgba(6, 182, 212, 0.2);
  color: #06b6d4;
}

.resolution-graph {
  background: rgba(99, 102, 241, 0.2);
  color: #6366f1;
}

.resolution-dialog {
  background: rgba(139, 92, 246, 0.2);
  color: #8b5cf6;
}

.resolution-trained {
  background: rgba(236, 72, 153, 0.2);
  color: #ec4899;
}

.state-tensors {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.tensor-section {
  background: var(--color-bg-secondary);
  border-radius: 8px;
  padding: 0.75rem;
}

.tensor-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
  margin-bottom: 0.75rem;
}

.tensor-icon {
  font-size: 1.1em;
}

.tensor-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 0.5rem;
}

.tensor-field {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.field-key {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
}

.field-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.state-placeholder {
  padding: 1.5rem;
  text-align: center;
  background: rgba(99, 102, 241, 0.05);
  border-radius: 8px;
  border: 1px dashed var(--color-border);
}

.placeholder-text {
  font-size: 0.875rem;
  color: var(--color-text-muted);
  font-style: italic;
}

/* ==========================================================================
   DEPTH 5: DIALOGS
   ========================================================================== */

.tp-dialog {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--color-border);
}

.dialog-list {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.dialog-card {
  background: var(--color-bg-tertiary);
  border-radius: 8px;
  padding: 1.5rem;
  border: 1px solid var(--color-border);
}

.dialog-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--color-border);
}

.dialog-participants {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.participant-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
  color: white;
  padding: 0.4rem 0.75rem;
  border-radius: 1.5rem;
  font-weight: 600;
  font-size: 0.875rem;
}

.dialog-turn-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--color-text-muted);
  background: var(--color-bg-primary);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
}

.dialog-transcript {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.dialog-turn {
  background: var(--color-bg-secondary);
  border-radius: 8px;
  padding: 1rem;
  border-left: 3px solid var(--color-accent);
}

.turn-speaker {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.speaker-icon {
  font-size: 1.25rem;
}

.speaker-name {
  font-weight: 700;
  color: var(--color-accent);
}

.speaker-emotion {
  font-size: 0.875rem;
  color: var(--color-text-muted);
  font-style: italic;
}

.turn-content {
  color: var(--color-text-primary);
  line-height: 1.7;
  margin-bottom: 0.5rem;
}

.turn-knowledge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
  padding: 0.5rem;
  background: rgba(99, 102, 241, 0.1);
  border-radius: 6px;
}

.knowledge-icon {
  font-size: 1rem;
}

.knowledge-text {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  font-style: italic;
}

.dialog-more {
  text-align: center;
  padding: 0.75rem;
  background: rgba(99, 102, 241, 0.05);
  border-radius: 8px;
  border: 1px dashed var(--color-border);
}

.more-text {
  font-size: 0.875rem;
  color: var(--color-text-muted);
  font-style: italic;
}

.dialog-summary {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--color-border);
}

.summary-label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
  margin-bottom: 0.5rem;
}

.summary-items {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.info-item {
  background: var(--color-bg-primary);
  color: var(--color-text-secondary);
  padding: 0.4rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
}

/* Navigation sidebar */
.timeline-nav {
  position: fixed;
  right: 2rem;
  top: 200px;
  width: 120px;
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 1rem;
  max-height: calc(100vh - 240px);
  overflow-y: auto;
}

.nav-title {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-muted);
  margin-bottom: 0.75rem;
}

.nav-item {
  display: block;
  padding: 0.5rem;
  margin-bottom: 0.25rem;
  text-decoration: none;
  color: var(--color-text-secondary);
  border-radius: 4px;
  transition: all 0.2s;
  position: relative;
}

.nav-item:hover {
  background: var(--color-bg-tertiary);
  color: var(--color-text-primary);
}

.nav-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  font-weight: 600;
}

.nav-importance-bar {
  position: absolute;
  bottom: 2px;
  left: 0.5rem;
  right: 0.5rem;
  height: 2px;
  background: var(--color-accent);
  border-radius: 1px;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--color-text-muted);
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.empty-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-secondary);
  margin-bottom: 0.5rem;
}

.empty-subtitle {
  font-size: 1rem;
}

/* ==========================================================================
   RESPONSIVE: MOBILE
   ========================================================================== */

@media (max-width: 768px) {
  :root {
    --spine-x-desktop: var(--spine-x-mobile);
    --card-width: calc(100vw - 160px);
    --card-gap: 40px;
  }

  .nav-header {
    padding: 0.75rem 1rem;
  }

  .metadata-summary {
    padding: 1rem;
  }

  .meta-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }

  .meta-value {
    font-size: 1.25rem;
  }

  .control-dashboard {
    padding: 0.75rem 1rem;
    gap: 1rem;
  }

  .control-section {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
    width: 100%;
  }

  .depth-controls, .entity-filters, .mechanism-filters {
    width: 100%;
  }

  .depth-btn, .entity-filter, .mech-filter {
    font-size: 0.75rem;
    padding: 0.4rem 0.75rem;
  }

  .timeline-cards {
    margin-left: var(--spine-x-mobile);
  }

  .timepoint-card {
    width: var(--card-width);
  }

  .timepoint-card.right {
    left: var(--card-gap);
    right: auto;
  }

  .timepoint-card.right .card-connector,
  .timepoint-card.right .tp-spine-marker {
    left: -var(--card-gap);
    right: auto;
  }

  .event-title {
    font-size: 1.5rem;
  }

  .timeline-nav {
    display: none;
  }
}
</style>
