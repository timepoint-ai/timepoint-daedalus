---
title: "Timepoint Simulation Dashboard"
format:
  html:
    page-layout: full
    code-tools: false
    code-fold: false
    include-in-header:
      - text: |
          <script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>
          <link href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
          <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
---

```{ojs}
//| echo: false

// API configuration
API_BASE = "http://localhost:8000"

// Get run_id from URL parameter
urlParams = new URLSearchParams(window.location.search)
runIdFromUrl = urlParams.get('run_id')

// Load static data
staticData = FileAttachment("dashboard_data.json").json()

// Fetch run data from API if run_id is in URL, otherwise use static data
displayRun = runIdFromUrl
  ? await (async () => {
      try {
        const response = await fetch(`${API_BASE}/api/run/${runIdFromUrl}`);
        if (!response.ok) throw new Error('Run not found');
        const runDetails = await response.json();

        // Fetch narrative if available
        try {
          const narrativeResp = await fetch(`${API_BASE}/api/narrative/${runIdFromUrl}`);
          if (narrativeResp.ok) {
            runDetails.narrative = await narrativeResp.json();
          }
        } catch (e) {
          console.log('No narrative available');
        }

        return runDetails;
      } catch (error) {
        console.error('Error fetching run:', error);
        return null;
      }
    })()
  : (await staticData).selected_run
```

```{ojs}
//| echo: false

navLinks = runIdFromUrl
  ? html`<div class="callout callout-style-default callout-note">
      <div class="callout-header d-flex align-content-center">
        <div class="callout-icon-container"><i class="callout-icon"></i></div>
        <div class="callout-title-container flex-fill">Navigation</div>
      </div>
      <div class="callout-body-container callout-body">
        <p><a href="runs.html">‚Üê Browse All Runs</a> | <a href="analytics.html">View Meta-Analytics</a> | <a href="screenplay.html?run_id=${runIdFromUrl}">üìÑ Screenplay</a> | <a href="dialogs.html?run_id=${runIdFromUrl}">üí¨ Dialogs</a> | <button onclick="window.location.reload()" style="float: right; background: #0d6efd; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 0.25rem; cursor: pointer;">üîÑ Refresh</button></p>
      </div>
    </div>`
  : html`<div class="callout callout-style-default callout-note">
      <div class="callout-header d-flex align-content-center">
        <div class="callout-icon-container"><i class="callout-icon"></i></div>
        <div class="callout-title-container flex-fill">Navigation</div>
      </div>
      <div class="callout-body-container callout-body">
        <p><a href="runs.html">‚Üê Browse All Runs</a> | <a href="analytics.html">View Meta-Analytics</a></p>
      </div>
    </div>`
```

```{ojs}
//| echo: false

// Fetch recent runs for homepage
recentRuns = !runIdFromUrl
  ? await (async () => {
      try {
        const response = await fetch(`${API_BASE}/api/runs?sort_by=started_at&order=DESC&limit=3&status=completed&min_timepoints=3`);
        if (!response.ok) return [];
        const data = await response.json();
        return data.runs || [];
      } catch (error) {
        console.error('Error fetching recent runs:', error);
        return [];
      }
    })()
  : []
```

```{ojs}
//| echo: false

recentRunsSection = !runIdFromUrl && recentRuns.length > 0
  ? html`<div style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid #6366f1; border-radius: 8px;">
      <h2 style="margin: 0 0 1rem 0; color: #a78bfa; font-size: 1.5rem;">üïê Recent Runs</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
        ${recentRuns.map(run => {
          const hasData = run.status === 'completed' && run.cost_usd > 0 && run.entities_created > 0 && run.timepoints_created > 2;
          return html`<div onclick="window.location.href='index.html?run_id=${run.run_id}'"
            style="cursor: pointer; padding: 1.25rem; background: rgba(30, 41, 59, 0.6); border: 1px solid #475569; border-radius: 8px; transition: all 0.2s; position: relative;"
            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(99,102,241,0.3)'; this.style.borderColor='#6366f1'"
            onmouseout="this.style.transform=''; this.style.boxShadow=''; this.style.borderColor='#475569'">
            ${hasData ? '<div style="position: absolute; top: 0.75rem; right: 0.75rem; width: 12px; height: 12px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 8px rgba(34,197,94,0.6);"></div>' : ''}
            <div style="font-weight: 700; font-size: 0.875rem; color: #cbd5e1; margin-bottom: 0.5rem; font-family: monospace;">${run.run_id}</div>
            <div style="font-size: 1.125rem; font-weight: 600; color: #f8fafc; margin-bottom: 0.75rem;">${run.template_id}</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
              <div style="background: rgba(99,102,241,0.15); padding: 0.5rem; border-radius: 4px;">
                <div style="font-size: 0.75rem; color: #94a3b8;">Entities</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #6366f1;">${run.entities_created}</div>
              </div>
              <div style="background: rgba(139,92,246,0.15); padding: 0.5rem; border-radius: 4px;">
                <div style="font-size: 0.75rem; color: #94a3b8;">Timepoints</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6;">${run.timepoints_created}</div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #94a3b8;">
              <span>üí∞ $${run.cost_usd.toFixed(3)}</span>
              <span>${new Date(run.started_at).toLocaleDateString()}</span>
            </div>
          </div>`;
        }).join('')}
      </div>
      <div style="text-align: center; margin-top: 1rem;">
        <a href="runs.html" style="display: inline-block; padding: 0.5rem 1.5rem; background: #6366f1; color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; transition: background 0.2s;"
           onmouseover="this.style.background='#4f46e5'" onmouseout="this.style.background='#6366f1'">
          View All Runs ‚Üí
        </a>
      </div>
    </div>`
  : html``
```

## Run Overview

::: {.grid}

::: {.g-col-12 .g-col-md-6}
### üìä Run Metadata

```{ojs}
//| echo: false

html`
<div class="metadata-card">
  <div class="metadata-row">
    <span class="label">Run ID:</span>
    <span class="value"><code>${displayRun?.run_id || 'N/A'}</code></span>
  </div>
  <div class="metadata-row">
    <span class="label">Template:</span>
    <span class="value">${displayRun?.template_id || 'N/A'}</span>
  </div>
  <div class="metadata-row">
    <span class="label">Status:</span>
    <span class="value status-${displayRun?.status?.toLowerCase()}">${displayRun?.status || 'N/A'}</span>
  </div>
  <div class="metadata-row">
    <span class="label">Causal Mode:</span>
    <span class="value">${displayRun?.causal_mode || 'N/A'}</span>
  </div>
  <div class="metadata-row">
    <span class="label">Cost:</span>
    <span class="value">$${displayRun?.cost_usd?.toFixed(3) || '0.000'}</span>
  </div>
  <div class="metadata-row">
    <span class="label">Started:</span>
    <span class="value">${displayRun?.started_at?.substring(0,19).replace('T',' ') || 'N/A'}</span>
  </div>
  <div class="metadata-row">
    <span class="label">Completed:</span>
    <span class="value">${displayRun?.completed_at?.substring(0,19).replace('T',' ') || 'N/A'}</span>
  </div>
  <div class="metadata-row">
    <span class="label">Duration:</span>
    <span class="value">${displayRun?.duration_seconds ? Math.round(displayRun.duration_seconds) + 's' : 'N/A'}</span>
  </div>
</div>
`
```
:::

::: {.g-col-12 .g-col-md-6}
### üéØ Simulation Stats

```{ojs}
//| echo: false

html`
<div class="stats-card">
  <div class="stat-box">
    <div class="stat-value">${displayRun?.entities_created || 0}</div>
    <div class="stat-label">Entities</div>
  </div>
  <div class="stat-box">
    <div class="stat-value">${displayRun?.timepoints_created || 0}</div>
    <div class="stat-label">Timepoints</div>
  </div>
  <div class="stat-box">
    <div class="stat-value">${displayRun?.llm_calls || 0}</div>
    <div class="stat-label">LLM Calls</div>
  </div>
  <div class="stat-box">
    <div class="stat-value">${displayRun?.tokens_used ? Math.round(displayRun.tokens_used / 1000) + 'k' : '0'}</div>
    <div class="stat-label">Tokens</div>
  </div>
</div>
`
```
:::

::: {.g-col-12}
### üîß Mechanisms Used

```{ojs}
//| echo: false

mechanismsUsed = displayRun?.mechanism_usage || []
uniqueMechanisms = mechanismsUsed.reduce((acc, m) => {
  const name = m.mechanism;
  acc[name] = (acc[name] || 0) + 1;
  return acc;
}, {})

html`<div class="mechanisms-grid">
  ${Object.entries(uniqueMechanisms).map(([name, count]) =>
    html`<span class="mechanism-badge" title="${count} uses">${name} (${count})</span>`
  ).join('')}
  ${Object.keys(uniqueMechanisms).length === 0 ? '<span class="text-muted">No mechanisms tracked</span>' : ''}
</div>

<style>
  .mechanisms-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .mechanism-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.35rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
  }
</style>
`
```
:::

::: {.g-col-12}
### ‚öôÔ∏è Temporal Model & Fidelity Strategy

```{ojs}
//| echo: false

fidelityStrategy = displayRun?.fidelity_strategy_json
  ? (typeof displayRun.fidelity_strategy_json === 'string'
      ? JSON.parse(displayRun.fidelity_strategy_json)
      : displayRun.fidelity_strategy_json)
  : null

html`${fidelityStrategy ? `
  <div style="display: grid; gap: 1rem;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; border-radius: 8px; color: white;">
        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">Causality Mode</div>
        <div style="font-size: 1.5rem; font-weight: 700; text-transform: uppercase;">${fidelityStrategy.mode || displayRun.causal_mode}</div>
      </div>
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 1rem; border-radius: 8px; color: white;">
        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">Planning Mode</div>
        <div style="font-size: 1.5rem; font-weight: 700; text-transform: capitalize;">${fidelityStrategy.planning_mode || 'N/A'}</div>
      </div>
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 1rem; border-radius: 8px; color: white;">
        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">Token Budget</div>
        <div style="font-size: 1.5rem; font-weight: 700;">${fidelityStrategy.token_budget ? Math.round(fidelityStrategy.token_budget).toLocaleString() : 'N/A'}</div>
      </div>
      <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 1rem; border-radius: 8px; color: white;">
        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">Budget Compliance</div>
        <div style="font-size: 1.5rem; font-weight: 700;">${displayRun.token_budget_compliance ? (displayRun.token_budget_compliance * 100).toFixed(1) + '%' : 'N/A'}</div>
      </div>
    </div>

    ${fidelityStrategy.fidelity_schedule ? `
    <div style="background: rgba(30, 41, 59, 0.5); padding: 1rem; border-radius: 8px; border: 1px solid #475569;">
      <div style="font-weight: 600; margin-bottom: 0.75rem; color: #cbd5e1;">Fidelity Schedule (Temporal Resolution per Timepoint)</div>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        ${fidelityStrategy.fidelity_schedule.map((res, idx) => {
          const colors = {
            'trained': '#22c55e',
            'dialog': '#3b82f6',
            'graph': '#8b5cf6',
            'scene': '#ec4899',
            'tensor_only': '#64748b'
          };
          const color = colors[res] || '#94a3b8';
          return `<div style="background: ${color}; color: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;" title="Timepoint ${idx + 1}: ${res}">
            ${idx + 1}: ${res}
          </div>`;
        }).join('')}
      </div>
      <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #94a3b8;">
        <span style="margin-right: 1rem;">üü¢ Trained</span>
        <span style="margin-right: 1rem;">üîµ Dialog</span>
        <span style="margin-right: 1rem;">üü£ Graph</span>
        <span style="margin-right: 1rem;">ü©∑ Scene</span>
        <span>‚ö™ Tensor Only</span>
      </div>
    </div>
    ` : ''}

    ${fidelityStrategy.allocation_rationale ? `
    <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #6366f1;">
      <div style="font-weight: 600; margin-bottom: 0.5rem; color: #a78bfa;">Strategy Rationale</div>
      <div style="color: #cbd5e1; font-size: 0.875rem;">${fidelityStrategy.allocation_rationale}</div>
    </div>
    ` : ''}
  </div>
` : '<p style="color: #94a3b8; font-style: italic;">No fidelity strategy data available for this run (schema < 2.0)</p>'}`
```
:::

::: {.g-col-12}
### üìù Executive Summary

```{ojs}
//| echo: false

md`${displayRun?.narrative?.executive_summary || (displayRun?.timepoints_created > 0 ? '*Narrative JSON file not found. Run has data in database but needs export.*' : '*No narrative available for this run.*')}`
```
:::

:::

## Visualizations

```{ojs}
//| echo: false

viewof activeTab = Inputs.radio(
  ["Timeline", "Network", "Metrics"],
  {value: "Timeline"}
)
```

```{ojs}
//| echo: false

// Extract unique entities from timepoints for filtering
allEntities = {
  const timepoints = displayRun?.narrative?.timepoints || displayRun?.narrative?.timeline || [];
  const entitySet = new Set();
  timepoints.forEach(tp => {
    const entities = tp.entities_present || tp.entities || [];
    entities.forEach(e => entitySet.add(e));
  });
  return Array.from(entitySet).sort();
}

// Entity filter controls
viewof selectedEntities = activeTab === 'Timeline' && allEntities.length > 0
  ? Inputs.checkbox(
      allEntities,
      {
        value: allEntities,
        label: "Filter by Entity:",
        format: x => {
          const icons = {
            'customers': 'üë•',
            'timepoint': 'üè¢',
            'ken': 'üë®‚Äçüíº',
            'sean': 'üë®‚Äçüíº'
          };
          const icon = icons[x.toLowerCase()] || 'üë§';
          return `${icon} ${x}`;
        }
      }
    )
  : []
```

```{ojs}
//| echo: false

timeline_viz = {
  if (activeTab !== 'Timeline') return html`<div></div>`;

  const wrapper = html`<div style="position: relative;">
    <div id="timeline" style="height: auto; min-height: 500px; border: 1px solid #334155; border-radius: 8px; background: rgba(30, 41, 59, 0.6); cursor: pointer;"></div>
    <div id="timeline-tooltip" style="position: absolute; display: none; z-index: 1000; pointer-events: none; max-width: 350px; background: rgba(15, 23, 42, 0.98); border: 2px solid #6366f1; border-radius: 8px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #f8fafc;"></div>
    <div id="timepoint-detail-panel" style="display: none; margin-top: 1rem; padding: 1.5rem; border: 1px solid #334155; border-radius: 8px; background: rgba(30, 41, 59, 0.8); color: #f8fafc; opacity: 0; transition: opacity 0.3s ease-in-out;"></div>
  </div>`;

  const container = wrapper.querySelector('#timeline');
  const detailPanel = wrapper.querySelector('#timepoint-detail-panel');
  const tooltipDiv = wrapper.querySelector('#timeline-tooltip');

  const timepoints = displayRun?.narrative?.timepoints || displayRun?.narrative?.timeline || [];
  const dialogs = displayRun?.narrative?.dialogs || [];

  if (timepoints.length === 0) {
    const hasTimepointsInDB = displayRun?.timepoints_created > 0;
    const message = hasTimepointsInDB
      ? `‚ö†Ô∏è Run has ${displayRun.timepoints_created} timepoints in database, but narrative JSON not exported. Run may need re-export.`
      : '‚ö†Ô∏è No timepoint data available for this run';
    container.innerHTML = `<p style="padding: 40px; text-align: center; color: #cbd5e1;">${message}</p>`;
    return wrapper;
  }

  // Entity icon mapping
  const entityIcons = {
    'customers': 'üë•',
    'timepoint': 'üè¢',
    'ken': 'üë®‚Äçüíº',
    'sean': 'üë®‚Äçüíº'
  };

  // Get importance-based color
  const getImportanceColor = (importance) => {
    if (importance >= 0.7) return ['#6366f1', '#8b5cf6']; // High - bright gradient
    if (importance >= 0.4) return ['#667eea', '#764ba2']; // Medium - standard gradient
    return ['#64748b', '#475569']; // Low - muted gradient
  };

  // Function to build tooltip HTML
  const buildTooltipHTML = (tp, idx) => {
    const entities = tp.entities_present || tp.entities || [];
    const dialogCount = tp.dialog_turn_count || 0;
    return `
      <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #a78bfa;">
        ${tp.timepoint_id || `T${idx + 1}`}
      </div>
      <div style="margin-bottom: 8px; color: #e2e8f0; line-height: 1.4;">
        ${tp.event_description || 'No description'}
      </div>
      <div style="font-size: 13px; color: #cbd5e1; border-top: 1px solid #475569; padding-top: 8px; margin-top: 8px;">
        <div style="margin-bottom: 4px;">üìÖ ${new Date(tp.timestamp).toLocaleString()}</div>
        ${entities.length > 0 ? `<div style="margin-bottom: 4px;">üë• ${entities.length} entities: ${entities.slice(0, 3).join(', ')}${entities.length > 3 ? '...' : ''}</div>` : ''}
        ${dialogCount > 0 ? `<div style="margin-bottom: 4px;">üí¨ ${dialogCount} dialog turns</div>` : ''}
        ${tp.importance ? `<div>‚≠ê Importance: ${(tp.importance * 100).toFixed(0)}%</div>` : ''}
      </div>
      <div style="font-size: 11px; color: #94a3b8; margin-top: 8px; font-style: italic; border-top: 1px solid #334155; padding-top: 6px;">
        Click for full details
      </div>
    `;
  };

  // Function to show detail panel
  const showDetailPanel = (idx) => {
    const tp = timepoints[idx];
    if (!tp) return;

    const entities = tp.entities_present || tp.entities || [];
    const dialogCount = tp.dialog_turn_count || 0;

    // Find dialogs for this timepoint
    const tpDialogs = dialogs.filter(d =>
      d.timepoint_id === tp.timepoint_id ||
      d.timepoint === tp.timepoint_id
    );

    let detailHTML = `
      <div style="display: grid; gap: 1.5rem;">
        <div>
          <h3 style="margin: 0 0 1rem 0; color: #a78bfa; font-size: 1.5rem; border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem;">
            ${tp.timepoint_id || `Timepoint ${idx + 1}`}
          </h3>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 6px; border-left: 4px solid #6366f1;">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.25rem;">Timestamp</div>
            <div style="font-weight: 600;">${new Date(tp.timestamp).toLocaleString()}</div>
          </div>
          <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 6px; border-left: 4px solid #8b5cf6;">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.25rem;">Entities Present</div>
            <div style="font-weight: 600;">${entities.length} entities</div>
          </div>
          ${dialogCount > 0 ? `
          <div style="background: rgba(167, 139, 250, 0.1); padding: 1rem; border-radius: 6px; border-left: 4px solid #a78bfa;">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.25rem;">Dialog Turns</div>
            <div style="font-weight: 600;">${dialogCount}</div>
          </div>
          ` : ''}
          ${tp.importance !== undefined ? `
          <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 6px; border-left: 4px solid #6366f1;">
            <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.25rem;">Importance</div>
            <div style="font-weight: 600;">${(tp.importance * 100).toFixed(0)}%</div>
          </div>
          ` : ''}
        </div>

        <div>
          <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600;">Event Description</div>
          <div style="background: rgba(30, 41, 59, 0.5); padding: 1rem; border-radius: 6px; border: 1px solid #475569;">
            ${tp.event_description || 'No description available'}
          </div>
        </div>

        ${entities.length > 0 ? `
        <div>
          <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600;">Characters Involved</div>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            ${entities.map(e => `
              <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.35rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600;">
                ${e}
              </span>
            `).join('')}
          </div>
        </div>
        ` : ''}

        ${tpDialogs.length > 0 ? `
        <div>
          <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.5rem; font-weight: 600;">Dialog</div>
          <div style="background: rgba(30, 41, 59, 0.5); padding: 1rem; border-radius: 6px; border: 1px solid #475569; max-height: 300px; overflow-y: auto;">
            ${tpDialogs.map(d => `
              <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #475569;">
                <div style="font-weight: 600; color: #a78bfa; margin-bottom: 0.25rem;">${d.speaker || 'Unknown'}</div>
                <div style="color: #cbd5e1;">${d.text || d.content || ''}</div>
              </div>
            `).join('')}
          </div>
        </div>
        ` : dialogCount > 0 ? `
        <div style="color: #94a3b8; font-style: italic; font-size: 0.875rem;">
          üí¨ ${dialogCount} dialog turns recorded (full dialog data not available in current view)
        </div>
        ` : ''}

        <div style="text-align: right;">
          <button id="close-detail-btn" style="background: #6366f1; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: background 0.2s;">
            Close
          </button>
        </div>
      </div>
    `;

    detailPanel.innerHTML = detailHTML;
    detailPanel.style.display = 'block';
    setTimeout(() => { detailPanel.style.opacity = '1'; }, 10);

    // Attach close handler
    const closeBtn = detailPanel.querySelector('#close-detail-btn');
    if (closeBtn) {
      closeBtn.onclick = () => {
        detailPanel.style.opacity = '0';
        setTimeout(() => { detailPanel.style.display = 'none'; }, 300);
      };
    }

    detailPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  };

  // Observable invalidation cleanup
  invalidation.then(() => {
    if (container._timeline) {
      container._timeline.destroy();
    }
  });

  // Initialize timeline
  setTimeout(() => {
    // Create groups for each entity (swimlanes)
    const groups = allEntities.map(entity => ({
      id: entity,
      content: `${entityIcons[entity.toLowerCase()] || 'üë§'} ${entity}`,
      visible: selectedEntities.includes(entity),
      className: `entity-group-${entity.toLowerCase()}`,
      style: 'font-weight: 600; font-size: 14px;'
    }));

    // Create items - one item per entity per timepoint
    const items = [];
    timepoints.forEach((tp, idx) => {
      const entities = tp.entities_present || tp.entities || [];
      const timestamp = tp.timestamp || `2025-01-${String(idx + 1).padStart(2, '0')}`;
      const importance = tp.importance !== undefined ? tp.importance : 0.5;
      const [color1, color2] = getImportanceColor(importance);

      // Create an item in each entity's swimlane for this timepoint
      entities.forEach(entity => {
        if (selectedEntities.includes(entity)) {
          items.push({
            id: `${idx}_${entity}`,
            content: `${entityIcons[entity.toLowerCase()] || 'üë§'} ${tp.timepoint_id || `T${idx + 1}`}`,
            start: new Date(timestamp),
            group: entity,
            type: 'box',
            className: `timepoint-item tp-${idx}`,
            style: `background: linear-gradient(135deg, ${color1} 0%, ${color2} 100%); border: 2px solid ${color1}; color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-width: 120px; padding: 8px;`,
            timepointIndex: idx
          });
        }
      });
    });

    const options = {
      height: 'auto',
      margin: { item: { horizontal: 10, vertical: 8 } },
      orientation: 'top',
      showCurrentTime: false,
      groupHeightMode: 'auto',
      verticalScroll: true,
      zoomKey: 'ctrlKey',
      horizontalScroll: true,
      timeAxis: { scale: 'month', step: 1 },
      format: {
        minorLabels: {
          month: 'MMM',
          year: 'YYYY'
        },
        majorLabels: {
          month: 'YYYY',
          year: ''
        }
      }
    };

    const timeline = new vis.Timeline(container, items, groups, options);
    container._timeline = timeline;

    // vis-timeline click event (primary)
    timeline.on('click', function(properties) {
      if (properties.item !== null && properties.item !== undefined) {
        // Extract timepoint index from item id (format: "idx_entity")
        const itemId = properties.item;
        const itemData = items.find(i => i.id === itemId);
        if (itemData && itemData.timepointIndex !== undefined) {
          showDetailPanel(itemData.timepointIndex);
        }
      }
    });

    // DOM click event (fallback)
    container.addEventListener('click', (e) => {
      const item = e.target.closest('.vis-item');
      if (item && timeline) {
        // Look for timepoint class (tp-N)
        const classList = Array.from(item.classList);
        const tpClass = classList.find(c => c.startsWith('tp-'));
        if (tpClass) {
          const idx = parseInt(tpClass.replace('tp-', ''));
          if (!isNaN(idx) && idx >= 0 && idx < timepoints.length) {
            showDetailPanel(idx);
          }
        }
      }
    });

    // Custom hover tooltip
    let currentHoverIdx = null;
    container.addEventListener('mousemove', (e) => {
      const item = e.target.closest('.vis-item');
      if (item) {
        // Extract timepoint index from class
        const classList = Array.from(item.classList);
        const tpClass = classList.find(c => c.startsWith('tp-'));

        if (tpClass) {
          const idx = parseInt(tpClass.replace('tp-', ''));
          if (!isNaN(idx) && idx >= 0 && idx < timepoints.length && idx !== currentHoverIdx) {
            currentHoverIdx = idx;
            tooltipDiv.innerHTML = buildTooltipHTML(timepoints[idx], idx);
            tooltipDiv.style.display = 'block';
          }
        }

        // Position tooltip near mouse
        tooltipDiv.style.left = (e.pageX - wrapper.offsetLeft + 15) + 'px';
        tooltipDiv.style.top = (e.pageY - wrapper.offsetTop - 80) + 'px';

        // Add hover effect to all items for this timepoint
        const allTpItems = container.querySelectorAll(`.${tpClass}`);
        allTpItems.forEach(i => {
          i.style.transform = 'scale(1.05)';
          i.style.boxShadow = '0 4px 12px rgba(99, 102, 241, 0.4)';
        });
      } else {
        tooltipDiv.style.display = 'none';
        currentHoverIdx = null;

        // Remove hover effects
        const allItems = container.querySelectorAll('.vis-item');
        allItems.forEach(i => {
          i.style.transform = '';
          i.style.boxShadow = '';
        });
      }
    });

    container.addEventListener('mouseleave', () => {
      tooltipDiv.style.display = 'none';
      currentHoverIdx = null;

      // Remove hover effects
      const allItems = container.querySelectorAll('.vis-item');
      allItems.forEach(i => {
        i.style.transform = '';
        i.style.boxShadow = '';
      });
    });
  }, 100);

  return wrapper;
}

network_viz = {
  if (activeTab !== 'Network') return html`<div></div>`;

  const container = html`<div style="height: 600px; border: 1px solid #334155; border-radius: 8px; background: rgba(30, 41, 59, 0.6);"></div>`;

  const characters = displayRun?.narrative?.characters || [];

  if (characters.length === 0) {
    const hasData = displayRun?.entities_created > 0 || displayRun?.timepoints_created > 0;
    const message = hasData
      ? '‚ö†Ô∏è Run has simulation data but narrative JSON not found. Visualization unavailable.'
      : '‚ö†Ô∏è No character data available for this run';
    container.innerHTML = `<p style="padding: 40px; text-align: center; color: #cbd5e1;">${message}</p>`;
    return container;
  }

  setTimeout(() => {
    const nodes = characters.map(char => ({
      data: {
        id: char.entity_id,
        label: char.entity_id.replace(/_/g, ' ')
      }
    }));

    const edges = [];
    characters.forEach(char => {
      if (char.relationships) {
        Object.entries(char.relationships).forEach(([target, rel]) => {
          if (characters.find(c => c.entity_id === target)) {
            edges.push({
              data: { source: char.entity_id, target: target, label: rel }
            });
          }
        });
      }
    });

    cytoscape({
      container: container,
      elements: [...nodes, ...edges],
      style: [
        {
          selector: 'node',
          style: {
            'background-color': '#6366f1',
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'font-size': '12px',
            'color': '#f8fafc',
            'width': 50,
            'height': 50
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#06b6d4',
            'target-arrow-color': '#06b6d4',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'label': 'data(label)',
            'font-size': '10px'
          }
        }
      ],
      layout: {
        name: 'cose',
        animate: true,
        idealEdgeLength: 100
      }
    });
  }, 100);

  return container;
}

metrics_viz = {
  if (activeTab !== 'Metrics') return html`<div></div>`;

  const container = html`<div style="height: 600px;"></div>`;

  const mechanisms = uniqueMechanisms || {};
  const mechanismNames = Object.keys(mechanisms);
  const mechanismValues = Object.values(mechanisms);

  if (mechanismNames.length === 0) {
    container.innerHTML = '<p style="padding: 40px; text-align: center; color: #cbd5e1;">‚ö†Ô∏è No mechanism data</p>';
    return container;
  }

  setTimeout(() => {
    const chart = echarts.init(container);

    chart.setOption({
      title: {
        text: 'Mechanism Coverage',
        left: 'center',
        top: 20,
        textStyle: { fontSize: 20, fontWeight: 'bold', color: '#f8fafc' }
      },
      tooltip: { trigger: 'item' },
      radar: {
        indicator: mechanismNames.map(name => ({
          name: name,
          max: Math.max(...mechanismValues, 10)
        })),
        radius: '60%',
        center: ['50%', '55%'],
        splitLine: { lineStyle: { color: 'rgba(99, 102, 241, 0.2)' } },
        axisLine: { lineStyle: { color: 'rgba(99, 102, 241, 0.3)' } },
        name: { textStyle: { color: '#cbd5e1' } }
      },
      series: [{
        type: 'radar',
        data: [{
          value: mechanismValues,
          name: 'Usage Count',
          areaStyle: { color: 'rgba(99, 102, 241, 0.3)' },
          lineStyle: { color: 'rgba(99, 102, 241, 1)', width: 2 },
          itemStyle: { color: 'rgba(99, 102, 241, 1)' }
        }]
      }]
    });
  }, 100);

  return container;
}
```

## Detailed Analysis

::: {.panel-tabset}

### Resolution Assignments

```{ojs}
//| echo: false

resolutions = displayRun?.resolution_assignments || []

html`<div style="max-height: 400px; overflow-y: auto;">
  <table style="width: 100%; border-collapse: collapse;">
    <thead style="position: sticky; top: 0; background: #f8f9fa;">
      <tr>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Entity ID</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Resolution</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Timepoint</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Timestamp</th>
      </tr>
    </thead>
    <tbody>
      ${resolutions.length > 0 ? resolutions.map(r => html`<tr>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><code>${r.entity_id}</code></td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">${r.resolution}</td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">${r.timepoint_id || 'N/A'}</td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><small>${r.timestamp}</small></td>
      </tr>`).join('') : '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #6c757d;">No resolution assignments</td></tr>'}
    </tbody>
  </table>
</div>`
```

### Validations

```{ojs}
//| echo: false

validations = displayRun?.validations || []

html`<div style="max-height: 400px; overflow-y: auto;">
  <table style="width: 100%; border-collapse: collapse;">
    <thead style="position: sticky; top: 0; background: #f8f9fa;">
      <tr>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Validator</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Result</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Message</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Timestamp</th>
      </tr>
    </thead>
    <tbody>
      ${validations.length > 0 ? validations.map(v => html`<tr>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">${v.validator_name}</td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">
          <span style="color: ${v.passed ? '#28a745' : '#dc3545'}; font-weight: 600;">
            ${v.passed ? '‚úì Passed' : '‚úó Failed'}
          </span>
        </td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">${v.message || ''}</td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><small>${v.timestamp}</small></td>
      </tr>`).join('') : '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #6c757d;">No validations</td></tr>'}
    </tbody>
  </table>
</div>`
```

### Mechanism Timeline

```{ojs}
//| echo: false

html`<div style="max-height: 400px; overflow-y: auto;">
  <table style="width: 100%; border-collapse: collapse;">
    <thead style="position: sticky; top: 0; background: #f8f9fa;">
      <tr>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Mechanism</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Function</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Context</th>
        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #dee2e6;">Timestamp</th>
      </tr>
    </thead>
    <tbody>
      ${mechanismsUsed.length > 0 ? mechanismsUsed.map(m => html`<tr>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><strong>${m.mechanism}</strong></td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><code style="font-size: 0.875rem;">${m.function_name}</code></td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><small>${m.context || ''}</small></td>
        <td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;"><small>${m.timestamp}</small></td>
      </tr>`).join('') : '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #6c757d;">No mechanism usage tracked</td></tr>'}
    </tbody>
  </table>
</div>`
```

:::

<style>
/* Timeline Responsive Styles */
@media (max-width: 768px) {
  /* Increase timeline height for better vertical view on mobile */
  #timeline {
    min-height: 600px !important;
  }

  /* Larger touch targets for timeline items */
  .vis-item {
    min-width: 100px !important;
    min-height: 48px !important;
    font-size: 14px !important;
  }

  /* Stack entity filter checkboxes vertically */
  .observablehq--inspect label {
    display: block !important;
    margin-bottom: 0.5rem !important;
  }

  /* Simplify timeline axis labels */
  .vis-time-axis .vis-text {
    font-size: 11px !important;
  }

  /* Reduce detail panel padding on mobile */
  #timepoint-detail-panel {
    padding: 1rem !important;
  }

  /* Make tooltip more mobile-friendly */
  #timeline-tooltip {
    max-width: 280px !important;
    font-size: 13px !important;
  }
}

/* Group styling */
.vis-label {
  padding: 8px 12px !important;
}

/* Hover effects for timeline items */
.vis-item:hover {
  cursor: pointer;
}

/* Active/selected item styling */
.vis-item.vis-selected {
  border-width: 3px !important;
  box-shadow: 0 0 12px rgba(99, 102, 241, 0.6) !important;
}

/* Group background alternation */
.vis-group:nth-child(even) {
  background-color: rgba(30, 41, 59, 0.3);
}

.vis-group:nth-child(odd) {
  background-color: rgba(30, 41, 59, 0.1);
}
</style>
